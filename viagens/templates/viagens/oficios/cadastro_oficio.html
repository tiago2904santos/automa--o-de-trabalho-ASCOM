{% extends 'viagens/base.html' %}

{% block title %}Cadastro de Of√≠cio{% endblock %}

{% block content %}
<div class="page-grid">

    <div class="form-card">
        <h2>Cadastro de Of√≠cio</h2><br>

        <form method="post">
            {% csrf_token %}

            <!-- ================= SERVIDOR ================= -->
            <div class="form-group autocomplete">
                <label>Servidor(es)</label>
                <input type="text" id="servidor_input" placeholder="Digite para buscar..." autocomplete="off">
                <input type="hidden" name="servidor" id="servidor_id">
                <div class="autocomplete-list" id="servidor-list"></div>
            </div>

            <!-- ================= MOTORISTA ================= -->
            <div class="form-group autocomplete">
                <label>Motorista</label>
                <input type="text" id="motorista_input" placeholder="Digite para buscar..." autocomplete="off">
                <input type="hidden" name="motorista" id="motorista_id">
                <div class="autocomplete-list" id="motorista-list"></div>
            </div>

            <!-- ================= VE√çCULO ================= -->
            <div class="form-group autocomplete">
                <label>Ve√≠culo (placa)</label>
                <input type="text" id="veiculo_input" placeholder="Digite a placa..." autocomplete="off">
                <input type="hidden" name="veiculo" id="veiculo_id">
                <div class="autocomplete-list" id="veiculo-list"></div>
            </div>

            <!-- ================= SEDE ================= -->
            <div class="form-group">
                <label>Sede (Estado)</label>
                {{ form.estado_sede }}
            </div>

            <div class="form-group autocomplete">
                <label>Sede (Cidade)</label>
                <input type="text" id="cidade_sede_input" placeholder="Digite a cidade..." autocomplete="off">
                <input type="hidden" name="cidade_sede" id="cidade_sede_id">
                <div class="autocomplete-list" id="cidade-sede-list"></div>
            </div>

            <!-- ================= DESTINO ================= -->
            <div class="form-group">
                <label>Destino (Estado)</label>
                {{ form.estado_destino }}
            </div>

            <div class="form-group autocomplete">
                <label>Destino (Cidade)</label>
                <input type="text" id="cidade_destino_input" placeholder="Digite a cidade..." autocomplete="off">
                <input type="hidden" name="cidade_destino" id="cidade_destino_id">
                <div class="autocomplete-list" id="cidade-destino-list"></div>
            </div>

            <!-- ================= RESTANTE DO FORM ================= -->
            {% for field in form.visible_fields %}
                {% if field.name not in "servidor motorista veiculo estado_sede cidade_sede estado_destino cidade_destino" %}
                    <div class="form-group">
                        <label>{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <small class="error">{{ field.errors|striptags }}</small>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}

            <button type="submit" class="btn-primary">Salvar</button>
        </form>
    </div>

    <div class="illustration-card">
        <div class="icon">üß≥</div>
        <h3>Cadastro de Of√≠cios</h3>
        <p>Preencha os dados para registrar um novo of√≠cio.</p>
    </div>

</div>

<!-- ================= JS ================= -->
<script>
function setupAutocomplete(inputId, hiddenId, listId, url, labelField, extraParams = () => "") {
    const input = document.getElementById(inputId);
    const hidden = document.getElementById(hiddenId);
    const list = document.getElementById(listId);

    input.addEventListener("input", async () => {
        const q = input.value.trim();
        if (!q) {
            list.innerHTML = "";
            hidden.value = "";
            return;
        }

        const response = await fetch(`${url}?q=${q}${extraParams()}`);
        const data = await response.json();

        list.innerHTML = "";
        data.forEach(item => {
            const div = document.createElement("div");
            div.textContent = item[labelField];
            div.classList.add("autocomplete-item");

            div.onclick = () => {
                input.value = item[labelField];
                hidden.value = item.id;
                list.innerHTML = "";
            };

            list.appendChild(div);
        });
    });

    document.addEventListener("click", e => {
        if (!input.contains(e.target) && !list.contains(e.target)) {
            list.innerHTML = "";
        }
    });
}

/* ===== AUTOCOMPLETES ===== */
setupAutocomplete("servidor_input", "servidor_id", "servidor-list", "{% url 'buscar_servidores' %}", "nome");
setupAutocomplete("motorista_input", "motorista_id", "motorista-list", "{% url 'buscar_motoristas' %}", "nome");
setupAutocomplete("veiculo_input", "veiculo_id", "veiculo-list", "{% url 'buscar_veiculos' %}", "placa");

setupAutocomplete(
    "cidade_sede_input",
    "cidade_sede_id",
    "cidade-sede-list",
    "{% url 'buscar_cidades' %}",
    "cidade",
    () => `&estado=${document.getElementById("id_estado_sede").value}`
);

setupAutocomplete(
    "cidade_destino_input",
    "cidade_destino_id",
    "cidade-destino-list",
    "{% url 'buscar_cidades' %}",
    "cidade",
    () => `&estado=${document.getElementById("id_estado_destino").value}`
);
</script>

{% endblock %}
