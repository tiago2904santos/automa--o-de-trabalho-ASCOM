{% extends 'viagens/base.html' %}

{% block title %}Cadastro de Of√≠cio{% endblock %}

{% block content %}
<div class="page-grid">

    <!-- FORMUL√ÅRIO -->
    <div class="form-card">
        <h2>Cadastro de Of√≠cio</h2><br>

        <form method="post">
            {% csrf_token %}

            <!-- Servidor -->
            <div class="form-group autocomplete">
                <label for="id_servidor">Servidor</label>
                <input type="text" id="id_servidor_input" placeholder="Digite para buscar..." autocomplete="off">
                <input type="hidden" name="servidor" id="id_servidor">
                <div class="autocomplete-list" id="servidor-list"></div>
            </div>

            <!-- Motorista -->
            <div class="form-group autocomplete">
                <label for="id_motorista">Motorista</label>
                <input type="text" id="id_motorista_input" placeholder="Digite para buscar..." autocomplete="off">
                <input type="hidden" name="motorista" id="id_motorista">
                <div class="autocomplete-list" id="motorista-list"></div>
            </div>

            <!-- Placa -->
            <div class="form-group autocomplete">
                <label for="id_veiculo">Ve√≠culo (placa)</label>
                <input type="text" id="id_veiculo_input" placeholder="Digite a placa..." autocomplete="off">
                <input type="hidden" name="veiculo" id="id_veiculo">
                <div class="autocomplete-list" id="veiculo-list"></div>
            </div>

            <!-- Estado / Cidade (Sede) -->
            <div class="form-group">
                <label for="id_sede_estado">Estado (Sede)</label>
                <select id="id_sede_estado" class="form-control">
                    <option value="">Selecione o estado</option>
                    {% for estado in estados %}
                        <option value="{{ estado.id }}">{{ estado.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group autocomplete">
                <label for="id_sede_cidade">Cidade (Sede)</label>
                <input type="text" id="id_sede_cidade_input" placeholder="Selecione o estado primeiro..." autocomplete="off">
                <input type="hidden" name="sede" id="id_sede_cidade">
                <div class="autocomplete-list" id="sede-cidade-list"></div>
            </div>

            <!-- Estado / Cidade (Destino) -->
            <div class="form-group">
                <label for="id_destino_estado">Estado (Destino)</label>
                <select id="id_destino_estado" class="form-control">
                    <option value="">Selecione o estado</option>
                    {% for estado in estados %}
                        <option value="{{ estado.id }}">{{ estado.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group autocomplete">
                <label for="id_destino_cidade">Cidade (Destino)</label>
                <input type="text" id="id_destino_cidade_input" placeholder="Selecione o estado primeiro..." autocomplete="off">
                <input type="hidden" name="destino" id="id_destino_cidade">
                <div class="autocomplete-list" id="destino-cidade-list"></div>
            </div>

            <!-- Campos restantes do form -->
            {% for field in form.visible_fields %}
                {% if field.name not in "servidor motorista veiculo sede destino" %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <small class="error">{{ field.errors|striptags }}</small>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}

            <button type="submit" class="btn-primary">Salvar</button>
        </form>
    </div>

    <!-- CARD LATERAL -->
    <div class="illustration-card">
        <div class="icon">üß≥</div>
        <h3>Cadastro de Of√≠cios</h3>
        <p>
            Preencha os dados ao lado para registrar um novo of√≠cio
            no sistema da Central de Viagens ASCOM.
        </p>
        <p class="muted">
            Todos os campos obrigat√≥rios devem ser informados corretamente.
        </p>
    </div>

</div>

<!-- ================= JS ================= -->
<script>
function setupAutocomplete(inputId, hiddenId, listId, url, campoExibir = "nome") {
    const input = document.getElementById(inputId);
    const hidden = document.getElementById(hiddenId);
    const list = document.getElementById(listId);

    input.addEventListener("input", async () => {
        const query = input.value.trim();
        if (!query) {
            list.innerHTML = "";
            hidden.value = "";
            return;
        }

        try {
            const response = await fetch(`${url}?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            list.innerHTML = "";
            data.forEach(item => {
                const li = document.createElement("li");
                li.textContent = item[campoExibir]; // campo correto (nome ou placa)
                li.classList.add("autocomplete-item");

                li.addEventListener("click", () => {
                    input.value = item[campoExibir];
                    hidden.value = item.id;
                    list.innerHTML = "";
                });

                list.appendChild(li);
            });
        } catch (err) {
            console.error("Erro no autocomplete:", err);
        }
    });

    // Fecha a lista se clicar fora
    document.addEventListener("click", (e) => {
        if (!input.contains(e.target) && !list.contains(e.target)) {
            list.innerHTML = "";
        }
    });
}

// =====================
// Exemplo de uso
// =====================
setupAutocomplete("id_servidor_input", "id_servidor", "servidor-list", "{% url 'buscar_servidores' %}", "nome");
setupAutocomplete("id_motorista_input", "id_motorista", "motorista-list", "{% url 'buscar_motoristas' %}", "nome");
setupAutocomplete("id_veiculo_input", "id_veiculo", "veiculo-list", "{% url 'buscar_veiculos' %}", "placa");
</script>

<!-- ================= CSS ================= -->
<style>
.autocomplete {
    position: relative;
}

.autocomplete-list {
    position: absolute;
    z-index: 1000;
    top: 100%;
    left: 0;
    right: 0;
    border: 1px solid #cfd4dc;
    border-top: none;
    background-color: #fff;
    max-height: 200px;
    overflow-y: auto;
    border-radius: 0 0 6px 6px;
}

.autocomplete-item {
    padding: 8px 12px;
    cursor: pointer;
}

.autocomplete-item:hover {
    background-color: #f4f6fb;
}
</style>

{% endblock %}
